<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../../apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="../../favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="../../favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="../../favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="../../favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="../../favicon-128.png" sizes="128x128"> <meta name="application-name" content="Apache Camel"> <link rel="manifest" href="../../site.webmanifest"> <title>CAPI Gateway: Using Apache Camel at the European Commission - Apache Camel</title> <link rel="canonical" href="../../blog/capi-gateway/"> <link rel="stylesheet" href="../../_/css/site-c849d791d8.css"> </head> <body class="article"> <header class="header"> <nav class="navbar"> <div class="navbar-brand"> <a class="nav-logo" href="../../" title="Apache Camel"><span>Apache Camel</span></a> <div id="topbar-nav" class="navbar-menu"> <div class="navbar-end"> <a class="navbar-item" href="../../blog/">Blog</a> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Projects</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../projects/camel-k/">Camel K</a> <a class="navbar-item" href="../../projects/camel-quarkus/">Camel Quarkus</a> <a class="navbar-item" href="../../projects/camel-kafka-connector/">Camel Kafka Connector</a> <a class="navbar-item" href="../../camel-spring-boot/latest/">Camel Spring Boot</a> </div> </div> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Documentation</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../manual/latest/getting-started.html">Getting started</a> <a class="navbar-item" href="../../manual/latest/">User manual</a> <a class="navbar-item" href="../../components/latest/">Component reference</a> <a class="navbar-item" href="https://www.javadoc.io/doc/org.apache.camel/camel-api/latest/index.html">API Documentation</a> <a class="navbar-item" href="../../camel-k/latest/">Camel K</a> <a class="navbar-item" href="../../camel-quarkus/latest/">Camel Quarkus</a> <a class="navbar-item" href="../../camel-kafka-connector/latest/">Camel Kafka Connector</a> <a class="navbar-item" href="../../manual/latest/enterprise-integration-patterns.html">Enterprise Integration Patterns</a> <a class="navbar-item" href="../../manual/latest/camel-3-migration-guide.html">Camel 2.x to 3.0 Migration Guide</a> <a class="navbar-item" href="../../manual/latest/camel-3x-upgrade-guide.html">Camel 3.x Upgrade Guide</a> </div> </div> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Community</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../community/support/">Support</a> <a class="navbar-item" href="../../manual/latest/contributing.html">Contributing</a> <a class="navbar-item" href="../../community/user-stories/">User stories</a> <a class="navbar-item" href="../../community/articles/">Articles</a> <a class="navbar-item" href="../../community/books/">Books</a> <a class="navbar-item" href="../../community/team/">Team</a> </div> </div> <a class="navbar-item" href="../../download/">Download</a> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">About</a> <div class="navbar-dropdown"> <a class="navbar-item" href="https://www.apache.org/events/current-event.html">Apache events</a> <a class="navbar-item" href="https://www.apache.org/licenses/">License</a> <a class="navbar-item" href="../../security/">Security</a> <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a> <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a> </div> </div> </div> </div> <div class="navbar-fill"></div> <div class="navbar-search results-hidden"> <input id="search" class="search" placeholder="Search" autocomplete="off"> <div id="search_results"></div> </div> <div class="navbar-tools"> <a href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg class="brand-icon"><use href="../../_/img/brand-logos.svg#github"/></svg></a> <a href="https://gitter.im/apache/apache-camel" title="Chat on Gitter"><svg class="brand-icon"><use href="../../_/img/brand-logos.svg#gitter"/></svg></a> <a href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg class="brand-icon"><use href="../../_/img/brand-logos.svg#twitter"/></svg></a> </div> <button class="navbar-burger" data-target="topbar-nav" type="button"> <span></span> <span></span> <span></span> </button> </div> </nav> </header> <div class="body"> <main role="main blog"> <article class="blog doc"> <header> <a class="category" href="../../categories/Usecases/">USECASES</a> <h1><a href="https://camel.apache.org/blog/capi-gateway/">CAPI Gateway: Using Apache Camel at the European Commission</a></h1> </header> <div class="post"> <aside> <div class="summary">How an API Gateway is implemented using Camel at the European Comission</div> <time itemprop="published" datetime="2020-01-02" title="Thursday, January 2, 2020">January 2, 2020</time> <p>by <span rel="author">Rodrigo Coelho</span></p> <p> <a class="arrow prev" href="../../blog/2019-Numbers/" title="Previous post: Camel 2019 in Numbers">&#10094;</a> <a class="arrow next" href="../../blog/CustomWebApiComponent/" title="Next post: Custom Web API Component">&#10095;</a> </p> </aside> <div class="post-content"> <p>I&rsquo;ve been working at the European Commission for the last 4 years as a Software Architect, working for a unit responsible for developing reusable components, and advocating open source software. In this context, we organized already a couple of Hackathons and Bug bounties open to all the open source communities.</p> <p>In the team, we worked already a couple of times with Apache Camel, and I like the elegance and performance compared with other integration frameworks.</p> <p>Recently I was challenged to find alternatives to the existing API Gateway infrastructure and immediately started to search for products implemented on top of Apache Camel.</p> <p>Not being able to find any solution with all we need to offer, I decided to work on a small POC with the following features:</p> <ul> <li>Easy to customize API Gateway (since we have several customers, with a wide scope of needs and technologies, we need to be able to easily build custom components on top of an API Gateway core.) Ex.: Customize processors, Integrate with externals IdP, Implement custom API Manager Interface.)</li> <li>Light and easy to install.</li> <li>Decoupled components, Observability, Metrics, Database, API Manager Interface, Authorization, and Gateway.</li> <li>Traffic management (Applied per API or API Path)</li> <li>Automated traceability. (When a user deploys an API, we create Zipkin traces)</li> <li>Automated Metrics (When a user deploys an API, we create Prometheus metrics)</li> <li>Automated Dashboards (When a user deploys an API, we create Grafana dashboards)</li> <li>Block APIs after failed attempts.</li> <li>REST endpoints to manage your API&rsquo;s, Clients, Subscriptions, Certificates.</li> <li>Authorization integration with Keycloak.</li> </ul> <p>SO, WHY APACHE CAMEL?</p> <ul> <li>Open Source.</li> <li>Big and active community.</li> <li>Fast and reliable.</li> <li>Deep integration with Spring Boot.</li> <li>DSL Language.</li> <li>Know-how in the team.</li> <li>It supports all the integration patterns that you can remember.</li> </ul> <p>As part of the POC, I&rsquo;ve decided already to combine other technologies:</p> <ul> <li>Spring Boot</li> <li>Hazelcast distributed cache</li> <li>Prometheus</li> <li>Grafana</li> <li>Zipkin</li> <li>MongoDB</li> <li>Keycloak</li> </ul> <p>The POC is available, and currently being tested, already working with Apache Camel 3.0.0. Let&rsquo;s then go for some technical details&hellip;</p> <h2 id="architecture-overview">Architecture Overview</h2> <figure> <a href="../../blog/capi-gateway/CAPI-Gateway.png" title="Architecture Overview (Click to enlarge)"><img src="../../blog/capi-gateway/CAPI-Gateway_hu1109e52e8a892dffb13e3afe780ccdff_66685_800x0_resize_q95_gaussian_2.png" width="800" height="787" alt="Architecture Overview"></a> <figcaption>Architecture Overview (Click to enlarge)</figcaption> </figure> <h2 id="basic-route-definition">Basic Route Definition</h2> <pre><code>routeDefinition
  .streamCaching()
  .setHeader(...) //core headers
  .process(authenticationProcessor)
  .choice()
      .when(...) //check execution of the authentication processor
      .process(pathProcessor) //evaluates the path
      .toF(toEndpoint) //proxy to the deployed backend
      .removeHeader(...) //remove some core headers
      .process(metricsProcessor) //process metrics

  //api was not authenticated (ex.: expired token)
  .otherwise()
      .setHeader(...) //core error headers
      .toF(apiGatewayErrorEndpoint) //proxy to default error endpoint
      .removeHeader(...) //remove some core headers
      .process(metricsProcessor) //process metrics
      .end()
      .setId(routeID);
</code></pre> <p>The <em>toEndpoint</em> contains the default configuration:</p> <pre><code>throwExceptionOnFailure=false //we will catch the exceptions
connectTimeout=...
bridgeEndpoint=true
copyHeaders=true
connectionClose=true
</code></pre> <p>Since we want to be able to catch Network, IO exceptions we also do this on the route definition:</p> <pre><code>routeDefinition
  .onException(exceptionClass)
  .continued(continued)
  .setHeader(...) //exception headers
  .toF(apiGatewayErrorEndpoint) //proxy to default error endpoint
  .removeHeader(...) //remove some core headers
  .end();
</code></pre> <p>All information about a running API can be found in the shared cache. This allows the component that manages APIs to know if an API must be suspended or temporarily blocked (due to failed attempts and/or many calls exceeding the defined threshold.) Information about a running API includes:</p> <ul> <li>Route ID</li> <li>Secured</li> <li>Zipkin Service Name and Prometheus Metrics Name</li> <li>Context</li> <li>Path</li> <li>Verb</li> <li>Failed calls</li> <li>Max allowed failed calls</li> <li>Disabled (temporarily disabled, a candidate to be removed)</li> <li>Removed (removed Route)</li> <li>Suspended info (type [ERROR, THROTTLING] and reason)</li> </ul> <p>Main components Managing enabled Routes:</p> <ul> <li>@Component @Scheduled <em>ThrottlingInspector</em> - Periodically checks the traffic on the deployed API Path level</li> <li>@Component @Scheduled <em>Running API&rsquo;s</em> - Periodically checks for API errors, candidates routes to suspend.</li> </ul> <h2 id="example-of-an-api-definition">Example of an API definition</h2> <pre><code>{
    &quot;_id&quot; : &quot;XXX-XXX-XXX-XXX&quot;,
    &quot;endpoint&quot; : &quot;remote.domain.com:8080&quot;,
    &quot;endpointType&quot; : &quot;HTTPS&quot;,
    &quot;name&quot; : &quot;Friendly API Name&quot;,
    &quot;secured&quot; : true,
    &quot;context&quot; : &quot;context-name&quot;,
    &quot;swagger&quot; : true,
    &quot;swaggerEndpoint&quot; : &quot;https://remote.domain.com:8080/v2/api-docs&quot;,
    &quot;blockIfInError&quot; : true,
    &quot;maxAllowedFailedCalls&quot; : 10, //after 10 failed calls, the route will be removed
    &quot;unblockAfter&quot; : true,
    &quot;unblockAfterMinutes&quot; : 2, //after 2 minutes of being removed, the route is added
    //100 calls per minute, above this, the route is suspended.
    &quot;throttlingPolicy&quot; : {
        &quot;maxCallsAllowed&quot; : &quot;100&quot;,
        &quot;periodForMaxCalls&quot; : &quot;60000&quot;,
        &quot;applyPerPath&quot; : true
    }
}
</code></pre> <p>With the following configuration your service will be available at:</p> <pre><code>https://localhost:8380/gateway/context-name/
</code></pre> <p>The following configuration will be applied: * secured: true - Meaning, that the CAPI Gateway expects a Bearer token sign by the authorization server (currently integrating with Keycloak) provided by the CAPI Rest Server. * blockIfInError: true - Means that for instance if you send more than 10 times (maxAllowedFailedCalls) the wrong token your API will be suspended for 2 minutes (unblockAfterMinutes). * throttlingPolicy.maxCallsAllowed: 100 / throttlingPolicy.periodForMaxCalls - You can only call your API/Path 100 times per minute. * throttlingPolicy.applyPerPath: true - If true the policy will be applied by the path and NOT the total amount for the API.</p> <h2 id="optional-configuration">Optional Configuration</h2> <p>You can define custom paths, in case you don&rsquo;t have a Swagger Endpoint (Swagger 2/Open API), so if swagger: false, then CAPI will look for a list of PATH like the below example:</p> <pre><code> {
     &quot;_id&quot; : &quot;XXX-XXX-XXX-XXX&quot;,
     &quot;endpoint&quot; : &quot;remote.domain.com:8080&quot;,
     &quot;endpointType&quot; : &quot;HTTPS&quot;,
     &quot;name&quot; : &quot;Friendly API Name&quot;,
     //this time, the API will be available for everyone
     &quot;secured&quot; : false,
     &quot;context&quot; : &quot;context-name&quot;,
     &quot;blockIfInError&quot; : false,
     //no swagger definition present, you need to define the available paths.
     &quot;swagger&quot; : false,
     &quot;paths&quot; : [
         {
         &quot;verb&quot; : &quot;GET&quot;,
         &quot;path&quot; : &quot;/services/path&quot;
         },
         {
         &quot;verb&quot; : &quot;POST&quot;,
         &quot;path&quot; : &quot;/services/path&quot;
         }
     ]
 }
</code></pre> <h2 id="client-consumer-object">Client (consumer) object</h2> <p>This will change after the integration with Keycloak. Example of a client (with the password: web-client-secret)</p> <pre><code>{
    &quot;_id&quot; : &quot;XXX-XXX-XXX-XXX&quot;,
    &quot;clientId&quot; : &quot;web-publisher&quot;,
    &quot;resourceIds&quot; : [],
    &quot;secretRequired&quot; : true,
    &quot;clientSecret&quot; : &quot;$2a$10$oQBqS4ZOEiIGVNiZnB0nMuFw/n/Od57IG/uy4nFuOJxLtHE/Z5jDC&quot;,
    &quot;scoped&quot; : false,
    &quot;scope&quot; : [
        &quot;read-foo&quot;
    ],
    &quot;authorizedGrantTypes&quot; : [
        &quot;refresh_token&quot;,
        &quot;client_credentials&quot;,
    ],
    &quot;registeredRedirectUri&quot; : [],
    &quot;authorities&quot; : [
        {
            &quot;role&quot; : &quot;ROLE_USER&quot;,
            &quot;_class&quot; : &quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;
        },
        {
            &quot;role&quot; : &quot;ROLE_PUBLISHER&quot;,
            &quot;_class&quot; : &quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;
        }
        // All the API's you subscribe will be an authority
    ],
    &quot;accessTokenValiditySeconds&quot; : 60,
    &quot;refreshTokenValiditySeconds&quot; : 14400,
    &quot;autoApprove&quot; : false
}
</code></pre> <h2 id="consuming-your-api">Consuming your API</h2> <p>If you wish to enable security for your API (api.secured = true), then you will need to define a <em>client</em>. Your API ID will be added as an authority in the authorities list of your client.</p> <pre><code>&quot;authorities&quot; : [
    {
        &quot;role&quot; : &quot;ROLE_USER&quot;,
        &quot;_class&quot; : &quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;
    },
    {
        &quot;role&quot; : &quot;ROLE_PUBLISHER&quot;,
        &quot;_class&quot; : &quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;
    },
    {
        &quot;role&quot; : &quot;YOUR API ID&quot;,
        &quot;_class&quot; : &quot;org.springframework.security.core.authority.SimpleGrantedAuthority&quot;
    }
]
</code></pre> <h2 id="play-with-capi-gateway">Play with CAPI Gateway</h2> <ul> <li>Clone the project.</li> <li><p>Execute</p> <pre><code>$ sudo docker-compose up -d
</code></pre></li> <li><p>If you are starting a new MongoDB instance, a default CAPI Client will be created for you.</p></li> <li><p>Request your first access token:</p> <pre><code>$ curl -X POST https://localhost:8080/oauth/token -H 'Authorization: Basic d2ViLXB1Ymxpc2hlcjp3ZWItY2xpZW50LXNlY3JldA==' -H 'Content-Type: multipart/form-data;' -F grant_type=client_credentials -F 'response_type=access_token'
</code></pre></li> <li><p>Go to <a href="http://localhost:8080/swagger-ui.html">http://localhost:8080/swagger-ui.html</a></p></li> <li><p>Authenticate with the token you obtained from the previous step. (Don&rsquo;t forget to specify: Bearer <em>the token</em>)</p></li> <li><p>Publish your first API:</p> <pre><code>$ curl -X POST &quot;http://localhost:8080/route/simple-rest&quot; -H &quot;accept: application/json&quot; -H &quot;Content-Type: application/json&quot; -d &quot;&lt;your-api&gt;&quot; (see Example of an API definition)
</code></pre></li> <li><p>Imagine that your context was: test and one of your GET path was /user you can then test: <a href="http://localhost:8380/gateway/test/user">http://localhost:8380/gateway/test/user</a></p></li> </ul> <p>Docker Compose will create instances of Grafana, Prometheus and Zipkin, but if you wish to use already existing instances you just need to change this environment variables:</p> <pre><code>api.gateway.prometheus.endpoint=http://prometheus:9090
api.gateway.zipkin.endpoint=http://zipkin:9411/api/v2/spans
api.gateway.grafana.endpoint=http://localhost:8080/grafana
</code></pre> <h2 id="some-load-results-calling-a-protected-service">Some load results (Calling a protected service)</h2> <h4 id="using-apache-benchmark-on-a-1-node-docker-container-with-ssl">Using apache benchmark on a 1 node docker container with SSL</h4> <pre><code>Results for 20k calls 1000 concurrency level:
Server Hostname:        localhost
Server Port:            8380
SSL/TLS Protocol:       TLSv1.2,ECDHE-RSA-AES256-GCM-SHA384,2048,256
Server Temp Key:        ECDH P-256 256 bits
TLS Server Name:        localhost

Document Path:          /gateway/myctx/internal/12345
Document Length:        33 bytes

Concurrency Level:      1000
Time taken for tests:   65.563 seconds
Complete requests:      20000
Failed requests:        0
Total transferred:      6560000 bytes
HTML transferred:       660000 bytes
Requests per second:    305.05 [#/sec] (mean)
Time per request:       3278.129 [ms] (mean)
Time per request:       3.278 [ms] (mean, across all concurrent requests)
Transfer rate:          97.71 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        7 2431 1388.0   2260   18381
Processing:     5  798 883.7    684   13862
Waiting:        3  796 883.3    681   13862
Total:         58 3229 1683.6   3091   18639
</code></pre> <p>It would be amazing to have feedback from the Apache Camel Community. If you have any questions, feel free to contact me. The repo is located at <a href="https://github.com/rodrigoserracoelho/capi-gateway">https://github.com/rodrigoserracoelho/capi-gateway</a></p> </div> </div> </article> </main> </div> <div class="edit"><a title="Improve this document, receive free virtual hugs &hearts;" href="https://github.com/apache/camel-website/edit/master/content/blog/capi-gateway/index.md">Edit this Page</a></div> <footer> <div class="footer"> <figure class="logo"> <img class="logo" src="../../_/img/logo-d.svg" alt="Apache Camel Logo" aria-label="white silhouette of a camel in front of a sand dune"> </figure> <dl> <dt>Overview</dt> <dd><a href="../../blog/">Blog</a></dd> <dd><a href="../../components/latest/">Components</a></dd> <dd><a href="../../download/">Download</a></dd> <dd><a href="../../manual/latest/getting-started.html">Getting started</a></dd> <dd><a href="../../manual/latest/faq.html">FAQ</a></dd> </dl> <dl> <dt>Community</dt> <dd><a href="../../community/support/">Support</a></dd> <dd><a href="../../manual/latest/contributing.html">Contributing</a></dd> <dd><a href="../../community/user-stories/">User stories</a></dd> <dd><a href="../../community/articles/">Articles</a></dd> <dd><a href="../../community/books/">Books</a></dd> <dd><a href="../../community/team/">Team</a></dd> </dl> <dl> <dt>About</dt> <dd><a href="../../acknowledgments/">Acknowledgments</a> </dd><dd><a target="_blank" href="https://www.apache.org/events/current-event.html" title="Apache Events">Apache Events</a></dd> <dd><a target="_blank" href="https://www.apache.org/licenses/" title="License">License</a></dd> <dd><a target="_blank" href="https://www.apache.org/security/" title="Security">Security</a></dd> <dd><a target="_blank" href="https://www.apache.org/foundation/sponsorship.html" title="Sponsorship">Sponsorship</a></dd> <dd><a target="_blank" href="https://www.apache.org/foundation/thanks.html" title="Thanks">Thanks</a></dd> </dl> <p> &copy; 2004-2020 The <a href="https://apache.org">Apache Software Foundation</a>.<br> Apache Camel, Camel, Apache, the Apache feather logo, and the Apache Camel project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners. </p> </div> </footer> <script src="../../_/js/vendor/alogliasearch-bc4f637dc4.js"></script> <script src="../../_/js/site-f4f4dbc142.js"></script> <script async src="../../_/js/vendor/highlight-54157f17f1.js"></script> <script async src="../../_/js/vendor/svg4everybody-195d47ce7d.js"></script> <script type="application/ld+json"> {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": "Apache Camel",
    "url": "https:\/\/camel.apache.org\/"
    , "sameAs": ["https://twitter.com/ApacheCamel"]
    , "logo": "https:\/\/camel.apache.org\/_\/img\/logo-d.svg"
    , "description": "Apache Camel â„¢ is a versatile open-source integration framework based on known Enterprise Integration Patterns. Camel empowers you to define routing and mediation rules in a variety of domain-specific languages, including a Java-based Fluent API, Spring or Blueprint XML Configuration files, and a Scala DSL." 
  } </script> <script type="application/ld+json"> {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position":  1 ,
        "item": {
          "@id": "https://camel.apache.org/",
          "name": "Apache Camel"
        }
    },{
        "@type": "ListItem",
        "position":  2 ,
        "item": {
          "@id": "https://camel.apache.org/blog/",
          "name": "blog"
        }
    },{
        "@type": "ListItem",
        "position":  3 ,
        "item": {
          "@id": "https://camel.apache.org/blog/capi-gateway/",
          "name": "capi-gateway"
        }
    }]
} </script> </body> </html> 